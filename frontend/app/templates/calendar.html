{% extends 'base.html' %}

{% block title %} Calendar {% endblock %}

{% block content %}
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <!-- Import specific CSS -->
    <link rel="stylesheet" href="static/css/calendarstyle.css">
    
    <!-- Greeting header -->
    <div style="margin-top: 75px;">
        <header class="masthead">
            <div class="container px-4 px-lg-5 d-flex h-100 align-items-center justify-content-center">
                <div class="d-flex justify-content-center">
                    <div class="text-center">
                        <h1 class="greeting-text mx-auto my-0 text-uppercase">LET'S FIND YOUR TEACHINGS!</h1>
                    </div>
                </div>
            </div>
        </header>
    </div>

    <!-- How to section -->
    <section>
        <div class="container" style="display: grid; place-items: center;">
            <h2 class="text-how_to text-center mt-5 mb-2">How to use Ca' Foscari Exchange Calendar</h2>
            <div class="align-items-center">
                <div>
                    <p class="lead fw-normal text-muted mb-5 mb-lg-0">
                        <ol class="lead">
                            <li>Prepare your query using all filters and send it to find more about a teaching.</li>
                            <li>Check the calendar to discover lecture scheduling.</li>
                            <li>Download information in .ics to add lectures to your preferred calendar client.</li>
                        </ol>
                    </p>
                    <p class="lead fw-normal text-muted mb-lg-0">
                        NOTE: It is not possible to search for more than one teaching at a time.
                    </p>
                </div>
            </div>
        </div>
    </section>

    <br>

    <!-- Database updating section -->
    <section class="database">
            <p class="text-database py-3 align-items-center">
                The calendar database was last updated at: {{ datatime_csv.datatime }}
            </p>
    </section>

    <div class="container mt-5">
        <!-- WTForms Form to get input from the user -->
        <form method="POST" id="query-form">
            {{ form.csrf_token }}
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.cycle.label }}
                        {{ form.cycle(class="form-control", id="form.cycle") }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.degreetype.label }}
                        {{ form.degreetype(class="form-control", id="form.degreetype") }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.credits.label }}
                        {{ form.credits(class="form-control", id="form.credits") }}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.location.label }}
                        {{ form.location(class="form-control", id="form.location") }}
                    </div>
                </div>
            </div>
            
            <!-- Show Teaching Filter Button -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        <button type="submit" class="btn btn-secondary" id="disc-teaching-btn">Discover your teachings</button>
                    </div>
                </div>
            </div>

            <!-- Teaching filter and submit button -->
            <div class="row" id="view-lect-row" style="display: none;">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.teaching.label }}
                        {{ form.teaching(class="form-control", id="id_teaching") }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </div>
            </div>
            </form>
            </div>

            <script>
            document.getElementById('disc-teaching-btn').addEventListener('click', function() {
            document.getElementById('view-lect-row').style.display = 'flex';
            });

            // Funzione per gestire la richiesta AJAX di ottenere gli insegnamenti filtrati
            function getTeachings() {
                var location = document.getElementById('form.location').value;
                var degreetype = document.getElementById('form.degreetype').value;
                var cycle = document.getElementById('form.cycle').value;
                var credits = document.getElementById('form.credits').value;

                const url = `http://localhost:8081/query?location_str=${encodeURIComponent(location)}&degreetype_str=${encodeURIComponent(degreetype)}&cycle_str=${encodeURIComponent(cycle)}&credits_str=${encodeURIComponent(credits)}`;

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! Status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        if (!Array.isArray(data)) {
                            throw new TypeError("Expected data to be an array");
                        }
                        data.forEach(teaching => {
                            console.log(teaching)
                            var option = document.createElement('option');
                            option.text = teaching;
                            option.value = teaching;
                            teachingSelect.appendChild(option);
                        });
                    })
                .catch(error => {
                    console.error('Error:', error);
                });
            }

            document.getElementById('query-form').addEventListener('submit', function(event) {
                event.preventDefault();
                getTeachings();
            });

            // Aggiungi questo listener all'evento submit del modulo
            document.getElementById('query-form').addEventListener('submit', function(event) {
            event.preventDefault();  // Evita il comportamento predefinito di inviare il modulo
            getTeachings();  // Esegui la funzione per ottenere gli insegnamenti filtrati
            });
            </script>


    <div class="container mt-5">
        <!-- Error message container -->
        <div id="error-message" class="mt-3 text-danger"></div>

        <!-- Calendar container -->
        <div id='calendar-container' class='mt-3' style='display: none; overflow: auto;'>
            <div id='calendar'></div>
        </div>
        <br>
        <br>

        <script src="../static/js/display_calendar.js"></script>
    </div>
{% endblock %}