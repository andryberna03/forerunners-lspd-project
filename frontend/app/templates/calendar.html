{% extends 'base.html' %}

{% block title %} Calendar {% endblock %}

{% block content %}
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar/index.global.min.js'></script>
    <link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css" />
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/tippy.js@6"></script>

    <div class="container mt-5">
        <p>The calendar database was last updated at: {{ datatime_csv.datatime }}</p>

        <!-- WTForms Form to get input from the user -->
        <form method="POST" id="query-form">
            {{ form.csrf_token }}
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.cycle.label }}
                        {{ form.cycle(class="form-control") }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.degreetype.label }}
                        {{ form.degreetype(class="form-control") }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.credits.label }}
                        {{ form.credits(class="form-control") }}
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.location.label }}
                        {{ form.location(class="form-control") }}
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.teaching.label }}
                        {{ form.teaching(class="form-control") }}
                    </div>
                </div>
            </div>
            <!-- Submit button -->
            <div class="row">
                <div class="col-md-4">
                    <div class="form-group">
                        {{ form.submit(class="btn btn-primary") }}
                    </div>
                </div>
            </div>
        </form>

        <!-- Error message container -->
        <div id="error-message" class="mt-3 text-danger"></div>

        <!-- Calendar container -->
        <div id='calendar-container' class='mt-3' style='display: none;'>
            <div id='calendar'></div>
        </div>
        <br>
        <br>

        <script>
            // Initialise calendar but show only after submit
            document.addEventListener('DOMContentLoaded', function() {
                var calendarEl = document.getElementById('calendar');
                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridWeek',
                    eventClick: function(info) {
                        info.jsEvent.preventDefault(); 
                        if (info.event.url) {
                            window.open(info.event.url, '_blank');
                        }
                    },
                    eventDidMount: function(info) {
                        // Add tooltip
                        var tooltipContent = `
                            <strong>${info.event.title}</strong><br>
                            <strong>Lecturer:</strong> ${info.event.extendedProps.lecturer}<br>
                            <strong>Classroom:</strong> ${info.event.extendedProps.classroom}<br>
                            <strong>Location:</strong> ${info.event.extendedProps.location}<br>
                            <strong>Address:</strong> ${info.event.extendedProps.address}<br>
                            <strong>Start time:</strong> ${info.event.extendedProps.start_time}<br>
                            <strong>End time:</strong> ${info.event.extendedProps.end_time}<br>
                            <strong>Credits:</strong> ${info.event.extendedProps.credits}<br>
                        `;
                        tippy(info.el, {
                            content: tooltipContent,
                            allowHTML: true,
                            theme: 'light',
                        });
                    }
                });

                // Populate the calendar
                document.getElementById('query-form').addEventListener('submit', function(event) {
                    event.preventDefault(); // Prevent actual form submission

                    // Show the calendar container
                    document.getElementById('calendar-container').style.display = 'block';

                    // Retrieve form values
                    var teaching = encodeURIComponent(document.querySelector('[name="teaching"]').value);
                    var location_str = encodeURIComponent(document.querySelector('[name="location"]').value);
                    var degreetype_str = encodeURIComponent(document.querySelector('[name="degreetype"]').value);
                    var cycle_str = encodeURIComponent(document.querySelector('[name="cycle"]').value);
                    var credits_str = encodeURIComponent(document.querySelector('[name="credits"]').value);

                    // Construct the URL with proper encoding
                    var url = `http://localhost:8081/query/${teaching}/${location_str}/${degreetype_str}/${cycle_str}/${credits_str}`;

                    console.log(url); // Debug URL

                    fetch(url)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('Network response was not ok ' + response.statusText);
                            }
                            return response.json();
                        })
                        .then(data => {
                            console.log(data);

                            var errorMessageEl = document.getElementById('error-message');
                            if (data && Object.keys(data).length > 0) {
                                errorMessageEl.textContent = ''; // Clear any previous error messages
                                var events = [];
                                for (var key in data) {
                                    if (data.hasOwnProperty(key)) {
                                        var lesson = data[key];
                                        events.push({
                                            title: lesson.TEACHING,
                                            start: lesson.START_ISO8601,
                                            end: lesson.END_ISO8601,
                                            url: lesson.URLS_INSEGNAMENTO,
                                            extendedProps: {
                                                lecturer: lesson.LECTURER_NAME,
                                                classroom: lesson.CLASSROOM_NAME,
                                                location: lesson.LOCATION_NAME,
                                                address: lesson.ADDRESS,
                                                start_time: lesson.LECTURE_START,
                                                end_time: lesson.LECTURE_END,
                                                credits: lesson.CREDITS,
                                            }
                                        });
                                    }
                                }
                                calendar.removeAllEvents(); // Clear existing events
                                calendar.addEventSource(events); // Add new data

                                // Find the earliest event date and move the calendar to that date
                                var earliestEvent = events.reduce((earliest, event) => {
                                    return !earliest || new Date(event.start) < new Date(earliest.start) ? event : earliest;
                                }, null);
                                if (earliestEvent) {
                                    calendar.gotoDate(new Date(earliestEvent.start));
                                }
                            } else {
                                // Show error if filters yield empty set
                                var errorMessageEl = document.getElementById('error-message')
                                errorMessageEl.textContent = 'Filter combination is not right';
                                console.error('Filter combination is not right');
                                 // Hide the calendar container if filters are wrong                                
                                 document.getElementById('calendar-container').style.display = 'none';
                            }
                        })
                        .catch(error => {
                            var errorMessageEl = document.getElementById('error-message');
                            errorMessageEl.textContent = 'Error loading the calendar data: ' + error.message;
                            console.error('Error loading the calendar data:', error);
                        });
                });

                calendar.render();
            });
        </script>

        <!-- move to static > css > calendar -->
        <style> 
            #error-message{
                color: red;
                font-weight: bold;
                margin-top: 20px;
            }
            .fc-event-title, .fc-event-time {
                white-space: normal;
                display: block;
            }
        </style>
    </div>
{% endblock %}